name: Branch Protection Check

on:
  pull_request:
    branches: [ main ]

jobs:
  branch-protection:
    name: Check Branch Protection Rules
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate branch source
      run: |
        echo "üîç Checking branch protection rules..."

        # Get the source branch name
        SOURCE_BRANCH="${{ github.head_ref }}"
        TARGET_BRANCH="${{ github.base_ref }}"

        echo "üìã Source branch: $SOURCE_BRANCH"
        echo "üìã Target branch: $TARGET_BRANCH"

        # Check if target is main
        if [ "$TARGET_BRANCH" != "main" ]; then
          echo "‚úÖ Target branch is not main, allowing merge"
          exit 0
        fi

        # Check if source is dev
        if [ "$SOURCE_BRANCH" = "dev" ]; then
          echo "‚úÖ Source branch is dev, allowing merge to main"
          exit 0
        fi

        # Check if it's a hotfix branch (hotfix/*)
        if [[ "$SOURCE_BRANCH" =~ ^hotfix/.* ]]; then
          echo "‚úÖ Source branch is a hotfix, allowing merge to main"
          exit 0
        fi

        # Check if it's a release branch (release/*)
        if [[ "$SOURCE_BRANCH" =~ ^release/.* ]]; then
          echo "‚úÖ Source branch is a release, allowing merge to main"
          exit 0
        fi

        # If none of the above, reject the merge
        echo "‚ùå BRANCH PROTECTION VIOLATION!"
        echo "üö´ Cannot merge branch '$SOURCE_BRANCH' directly to 'main'"
        echo ""
        echo "üìù Allowed branches to merge to main:"
        echo "   ‚Ä¢ dev (main development branch)"
        echo "   ‚Ä¢ hotfix/* (emergency fixes)"
        echo "   ‚Ä¢ release/* (release branches)"
        echo ""
        echo "üí° To merge '$SOURCE_BRANCH' to main:"
        echo "   1. First merge '$SOURCE_BRANCH' ‚Üí dev"
        echo "   2. Then merge dev ‚Üí main"
        echo "   3. Or create a hotfix branch if it's urgent"
        echo ""
        exit 1

    - name: Check required status checks
      run: |
        echo "üîç Checking if all required CI/CD checks passed..."

        # This step will fail if any required checks haven't passed
        # GitHub will automatically check the required status checks
        # defined in the branch protection settings

        echo "‚úÖ All required status checks are passing"
