name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  tag-main:
    name: Tag main from VERSION
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag (if missing)
        shell: bash
        run: |
          set -euo pipefail

          git fetch origin main --tags

          # Find the latest tag matching v*
          # Use xargs to trim potential whitespace, although sort should handle it
          LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | head -n 1)

          if [[ -z "$LATEST_TAG" ]]; then
            echo "‚ö†Ô∏è No previous release tag found. Proceeding with initial version."
          else
            echo "üè∑Ô∏è Latest release tag: $LATEST_TAG"

            # Extract version from old tag's VERSION file
            # tr -d is used to ensure no hidden characters interfere
            if git cat-file -e "$LATEST_TAG:VERSION" 2>/dev/null; then
              OLD_VER=$(git show "$LATEST_TAG:VERSION" | tr -d ' \t\r\n')
            else
              echo "‚ö†Ô∏è VERSION file missing in $LATEST_TAG. Assuming 0.0.0 baseline."
              OLD_VER="0.0.0"
            fi
            CUR_VER=$(tr -d ' \t\r\n' < VERSION)

            if [[ "$OLD_VER" == "$CUR_VER" ]]; then
              echo "‚ÑπÔ∏è VERSION ($CUR_VER) has not changed since $LATEST_TAG. Skipping."
              exit 0
            fi
            echo "üöÄ Version change detected: $OLD_VER -> $CUR_VER"
          fi

          if [[ ! -f VERSION ]]; then
            echo "‚ùå ERROR: VERSION file missing on main."
            exit 1
          fi

          VER="$(tr -d ' \t\r\n' < VERSION)"
          if ! [[ "$VER" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå ERROR: VERSION must be MAJOR.MINOR.PATCH, got: '$VER'"
            exit 1
          fi

          TAG="v$VER"
          echo "üè∑Ô∏è  Target tag: $TAG"

          git fetch --tags
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ÑπÔ∏è Tag already exists: $TAG (skipping)"
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

          echo "‚úÖ Created and pushed tag: $TAG"
